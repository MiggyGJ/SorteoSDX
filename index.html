<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDX Madrid - Room Draw</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Montserrat:wght@300;400;700&display=swap');

        :root {
            --ucl-blue: #000a2e;
            --ucl-gold: #c89b3c;
            --ucl-gold-light: #eec26b;
            --ucl-accent: #051a5c;
        }

        body {
            background: radial-gradient(circle at center, var(--ucl-accent) 0%, var(--ucl-blue) 100%);
            color: white;
            font-family: 'Montserrat', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .ucl-title {
            font-family: 'Cinzel', serif;
            letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(200, 155, 60, 0.5);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .star-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.3;
        }

        .presenter-container {
            position: relative;
            width: 180px;
            height: 180px;
            margin: 0 auto 1.5rem;
            border: 4px solid var(--ucl-gold);
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(200, 155, 60, 0.4);
        }

        @media (min-width: 768px) {
            .presenter-container { width: 250px; height: 250px; }
        }

        .presenter-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: contrast(110%);
        }

        .speech-text {
            font-size: 1.1rem;
            line-height: 1.6;
            font-style: italic;
            color: #ddd;
            animation: fadeIn 2s ease-in;
        }

        @media (min-width: 768px) {
            .speech-text { font-size: 1.25rem; line-height: 1.8; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ball-3d {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #ffffff 0%, #d1d1d1 50%, #888 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000a2e;
            font-weight: bold;
            box-shadow: inset -4px -4px 10px rgba(0,0,0,0.4), inset 4px 4px 10px rgba(255,255,255,0.8), 0 10px 20px rgba(0,0,0,0.5);
            position: relative;
            transform-style: preserve-3d;
        }

        @media (min-width: 768px) {
            .ball-3d { width: 80px; height: 80px; box-shadow: inset -8px -8px 20px rgba(0,0,0,0.4), inset 8px 8px 20px rgba(255,255,255,0.8), 0 15px 30px rgba(0,0,0,0.5); }
        }

        .pot-ball {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: absolute;
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.5);
        }

        .ball-p { background: radial-gradient(circle at 30% 30%, #fff, #bbb); }
        .ball-r { background: radial-gradient(circle at 30% 30%, var(--ucl-gold-light), var(--ucl-gold)); }

        @keyframes shuffle3d {
            0% { transform: translate3d(0, 0, 0) rotate(0deg); }
            25% { transform: translate3d(20px, -10px, 15px) rotate(90deg); }
            50% { transform: translate3d(-15px, 20px, -10px) rotate(180deg); }
            75% { transform: translate3d(-20px, -15px, 20px) rotate(270deg); }
            100% { transform: translate3d(0, 0, 0) rotate(360deg); }
        }

        .shuffling { animation: shuffle3d 0.8s infinite linear; }

        .bowl-3d {
            perspective: 800px;
            background: radial-gradient(circle at 50% 10%, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.02) 80%);
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 0 50px rgba(255,255,255,0.05);
        }

        .reveal-3d { animation: zoomInRotate 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes zoomInRotate {
            0% { transform: scale(0) rotateX(-90deg) rotateY(-90deg) translateZ(-200px); opacity: 0; }
            100% { transform: scale(1) rotateX(0) rotateY(0) translateZ(0); opacity: 1; }
        }

        .btn-ucl, .result-badge-gold {
            background: linear-gradient(135deg, #c89b3c 0%, #a67c2e 100%);
            color: #000a2e;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(200, 155, 60, 0.4);
            transition: all 0.3s ease;
        }

        .btn-ucl:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(200, 155, 60, 0.6);
        }

        .result-row {
            border-left: 4px solid var(--ucl-gold);
            animation: slideIn 0.5s ease-out forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #ai-commentary, #ai-farewell {
            min-height: 4.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: var(--ucl-gold-light);
            text-align: center;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 2px dashed rgba(200, 155, 60, 0.4);
            border-radius: 0.5rem;
            background: rgba(0, 10, 46, 0.4);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .participant-photo-frame {
            width: 120px;
            height: 160px;
            border: 3px solid var(--ucl-gold);
            border-radius: 0.75rem;
            overflow: hidden;
            margin: 0 auto 0.5rem;
            background: var(--ucl-blue);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transform-style: preserve-3d;
        }

        @media (min-width: 768px) {
            .participant-photo-frame { width: 140px; height: 180px; margin-bottom: 0.75rem; }
        }

        .summary-photo-frame {
            width: 80px;
            height: 105px;
            border: 2px solid rgba(200, 155, 60, 0.5);
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 0.4rem;
            background: rgba(0,0,0,0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .summary-photo-frame { width: 100px; height: 130px; margin-bottom: 0.5rem; }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--ucl-gold); border-radius: 10px; }

        .summary-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid rgba(200, 155, 60, 0.3);
            transition: transform 0.3s ease;
        }

        /* Bot√≥n de m√∫sica */
        #music-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid var(--ucl-gold);
            background: rgba(0, 10, 46, 0.8);
            box-shadow: 0 0 15px rgba(200, 155, 60, 0.4);
            transition: all 0.3s ease;
        }

        #music-toggle:hover {
            transform: scale(1.1);
            background: var(--ucl-gold);
        }

        #music-toggle:hover svg {
            fill: var(--ucl-blue);
        }

        #music-toggle svg {
            width: 24px;
            height: 24px;
            fill: var(--ucl-gold);
        }
    </style>
</head>
<body>

    <svg class="star-background" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <pattern id="starPattern" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                <path d="M50 5 L55 35 L85 40 L55 45 L50 75 L45 45 L15 40 L45 35 Z" fill="white" opacity="0.2" />
            </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#starPattern)" />
    </svg>

    <!-- Bot√≥n de Control de M√∫sica -->
    <div id="music-toggle" class="hidden" onclick="toggleMusic()">
        <svg id="music-on-icon" viewBox="0 0 24 24"><path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16.02C15.5,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>
        <svg id="music-off-icon" class="hidden" viewBox="0 0 24 24"><path d="M12,4L9.91,6.09L12,8.18V4M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73L4.27,3M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18.01,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.48,12.43 16.5,12.22 16.5,12Z"/></svg>
    </div>

    <!-- Contenedor del Player de YouTube -->
    <div id="player-container" style="position: absolute; top: -9999px; left: -9999px;">
        <div id="yt-player"></div>
    </div>

    <div class="container mx-auto px-4 py-6 md:py-8 max-w-4xl">
        <header class="text-center mb-6 md:mb-10">
            <h1 class="ucl-title text-3xl md:text-6xl font-bold text-white mb-2">SDX MADRID</h1>
            <p class="text-ucl-gold font-bold tracking-widest text-xs md:text-lg uppercase">Official Room Draw 2026</p>
        </header>

        <!-- PANTALLA DE BIENVENIDA -->
        <div id="welcome-screen" class="glass-panel p-6 md:p-10 text-center">
            <div class="presenter-container">
                <img src="assets/img/presentador.jpg" 
                     alt="Presentador SDX" 
                     class="presenter-img" 
                     id="main-presenter-img"
                     onerror="this.onerror=null; this.src='https://scontent-mad2-1.cdninstagram.com/v/t51.29350-15/459053758_1060397565676103_1944352040345782891_n.heic?stp=dst-jpg_e35_tt6&efg=eyJ2ZW5jb2RlX3RhZyI6IkNBUk9VU0VMX0lURU0uaW1hZ2VfdXJsZ2VuLjEwMDB4MTAwMC5zZHIuZjI5MzUwLmRlZmF1bHRfaW1hZ2UuYzIifQ&_nc_ht=scontent-mad2-1.cdninstagram.com&_nc_cat=111&_nc_oc=Q6cZ2QES5Sp9dBnaa7NyYAk1_UE2Ze-YNrgaUVsoEyU5Vx8cO4fWkO5jWY5Ewpu4lZplEOw1kZf0X4EOgfaw8aEio-X6&_nc_ohc=csqh364C9F8Q7kNvwGN0wVI&_nc_gid=CEmt9wA1qY699bKPyTZN0A&edm=AP4sbd4BAAAA&ccb=7-5&ig_cache_key=MzQ1NTYwMzM4NzM5MDM0Mzg3Nw%3D%3D.3-ccb7-5&oh=00_Afuk6S9RA3Lz_DPeiwKzBK4CJgV04Y1D5IIOR-Fwyd5f_Q&oe=698FD766&_nc_sid=7a9f4b';">
            </div>
            <div class="space-y-4 md:space-y-6 max-w-2xl mx-auto">
                <p class="speech-text">
                    "¬°Damas y caballeros‚Ä¶ bienvenidos al gran sorteo del <span class="text-ucl-gold font-bold">SDX CUP 2026</span>!<br><br>
                    Hoy se deciden los destinos‚Ä¶ las habitaciones donde descansar√°n los guerreros de esta edici√≥n.<br><br>
                    <span class="ucl-title text-white">¬°Comienza el sorteo de habitaciones del SDX CUP!"</span>
                </p>
                <button onclick="goToSetup()" class="btn-ucl px-8 md:px-10 py-3 md:py-4 rounded-full text-lg md:text-xl mt-4">
                    Entrar al Sorteo
                </button>
            </div>
        </div>

        <!-- SETUP -->
        <div id="setup-screen" class="hidden glass-panel p-6 md:p-10">
            <h2 class="text-2xl font-bold mb-6 text-center">Configuraci√≥n del Sorteo</h2>
            <div class="space-y-6">
                <div class="bg-blue-950/40 p-4 rounded-lg border border-ucl-gold/30">
                    <label class="block text-xs font-bold mb-1 text-ucl-gold uppercase">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-blue-900/30 border border-white/20 rounded p-2 text-white text-sm focus:border-ucl-gold focus:outline-none" placeholder="Pega tu clave aqu√≠...">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-300">Participantes (uno por l√≠nea)</label>
                    <textarea id="participants-input" rows="8" class="w-full bg-blue-900/30 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:border-ucl-gold" placeholder="Ej: Lucas...">Lucas
Alberto
Alfredo
Juan
Fran
Pablo
Mario</textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold mb-2 text-gray-300">N√∫mero de Habitaciones</label>
                        <input type="number" id="rooms-count" class="w-full bg-blue-900/30 border border-white/20 rounded-lg p-3 text-white focus:outline-none focus:border-ucl-gold transition-all" value="3" min="1">
                    </div>
                    <div class="flex items-end">
                        <button onclick="startDraw()" class="btn-ucl w-full py-3 rounded-lg">Configurar Bombos</button>
                    </div>
                </div>
                <p id="setup-error" class="text-red-400 text-sm hidden bg-red-900/20 p-2 rounded border border-red-900/50"></p>
            </div>
        </div>

        <!-- DRAW -->
        <div id="draw-screen" class="hidden">
            <div class="flex md:grid md:grid-cols-2 gap-4 md:gap-8 mb-4 md:mb-6">
                <div class="flex-1 glass-panel p-3 md:p-6 text-center flex flex-col items-center">
                    <h3 class="text-ucl-gold font-bold text-[10px] md:text-sm mb-2 uppercase tracking-tighter">Participantes</h3>
                    <div class="relative w-24 h-24 md:w-56 md:h-56 bowl-3d rounded-full flex items-center justify-center overflow-hidden">
                        <div id="pot-participants" class="absolute inset-0"></div>
                    </div>
                </div>

                <div class="flex-1 glass-panel p-3 md:p-6 text-center flex flex-col items-center">
                    <h3 class="text-ucl-gold font-bold text-[10px] md:text-sm mb-2 uppercase tracking-tighter">Habitaciones</h3>
                    <div class="relative w-24 h-24 md:w-56 md:h-56 bowl-3d rounded-full flex items-center justify-center overflow-hidden">
                        <div id="pot-rooms" class="absolute inset-0"></div>
                    </div>
                </div>
            </div>

            <div id="draw-focus-area" class="space-y-4">
                <div id="ai-commentary">¬°La sala VIP est√° expectante! El marcador de corazones echa humo...</div>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div id="current-participant" class="h-56 md:h-72 flex flex-col items-center justify-center glass-panel p-2">
                        <span class="text-xs md:text-xl font-bold italic text-white/20">Aspirante...</span>
                    </div>
                    <div id="current-room" class="h-56 md:h-72 flex items-center justify-center glass-panel p-2">
                        <span class="text-xs md:text-xl font-bold italic text-white/20">Destino...</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mb-8">
                <button id="draw-button" onclick="performDraw()" class="btn-ucl px-10 md:px-12 py-3 md:py-4 rounded-full text-lg md:text-xl shadow-2xl w-full md:w-auto">
                    ¬°Extraer Bolas!
                </button>
            </div>

            <div class="glass-panel p-6">
                <h3 class="text-xl font-bold mb-4 border-b border-white/10 pb-2">Resultados en Directo</h3>
                <div id="results-container" class="space-y-3 max-h-60 md:max-h-80 overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>
        </div>

        <!-- SUMMARY -->
        <div id="summary-screen" class="hidden glass-panel p-6 md:p-10">
            <div class="text-center mb-8">
                <h2 class="ucl-title text-2xl md:text-3xl font-bold text-ucl-gold mb-2">RESUMEN FINAL</h2>
                <p class="text-gray-400">Distribuci√≥n SDX CUP 2026</p>
            </div>
            
            <div id="ai-farewell" class="mb-8 italic">Generando discurso de clausura...</div>

            <div id="summary-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10"></div>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button onclick="resetApp()" class="btn-ucl px-8 py-3 rounded-lg text-sm">Reiniciar</button>
                <button onclick="window.print()" class="bg-white/10 px-8 py-3 rounded-lg text-sm font-bold border border-white/20">Imprimir / PDF</button>
            </div>
        </div>
    </div>

    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const participantPhotos = {
            "Lucas": "assets/img/participants/lucas.jpg",
            "Alberto": "assets/img/participants/alberto.jpg",
            "Alfredo": "assets/img/participants/alfredo.jpg",
            "Juan": "assets/img/participants/juan.jpg",
            "Fran": "assets/img/participants/fran.jpg",
            "Pablo": "assets/img/participants/pablo.jpg",
            "Mario": "assets/img/participants/mario.jpg"
        };

        let customApiKey = "";
        let participants = [];
        let rooms = [];
        let allResults = [];
        let isDrawing = false;
        let ytPlayer;
        let isMusicPlaying = false;

        // Inicializar Player de YouTube
        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('yt-player', {
                height: '0',
                width: '0',
                videoId: 'UnRG455M8YM',
                playerVars: {
                    'autoplay': 0,
                    'loop': 1,
                    'playlist': 'UnRG455M8YM'
                },
                events: {
                    'onReady': onPlayerReady
                }
            });
        }

        function onPlayerReady(event) {
            // El reproductor est√° listo pero no empezamos m√∫sica hasta que el usuario entre
        }

        function toggleMusic() {
            if (!ytPlayer) return;
            
            const onIcon = document.getElementById('music-on-icon');
            const offIcon = document.getElementById('music-off-icon');

            if (isMusicPlaying) {
                ytPlayer.pauseVideo();
                onIcon.classList.add('hidden');
                offIcon.classList.remove('hidden');
            } else {
                ytPlayer.playVideo();
                onIcon.classList.remove('hidden');
                offIcon.classList.add('hidden');
            }
            isMusicPlaying = !isMusicPlaying;
        }

        function goToSetup() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            document.getElementById('music-toggle').classList.remove('hidden');
            
            // Empezar m√∫sica autom√°ticamente al entrar
            if (ytPlayer && !isMusicPlaying) {
                ytPlayer.playVideo();
                isMusicPlaying = true;
            }
        }

        function resetApp() {
            participants = []; rooms = []; allResults = []; isDrawing = false;
            document.getElementById('summary-screen').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('ai-commentary').innerText = "¬°La sala VIP est√° expectante! El marcador de corazones echa humo...";
            document.getElementById('current-participant').innerHTML = '<span class="text-xl font-bold italic text-white/20">Aspirante...</span>';
            document.getElementById('current-room').innerHTML = '<span class="text-xl font-bold italic text-white/20">Destino...</span>';
            const drawBtn = document.getElementById('draw-button');
            drawBtn.innerText = "¬°Extraer Bolas!";
            drawBtn.onclick = performDraw;
            drawBtn.disabled = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function getAICommentary(person, room) {
            const commentaryElement = document.getElementById('ai-commentary');
            const keyToUse = customApiKey || "";
            if (!keyToUse) { commentaryElement.innerText = "¬°Vaya peligro tiene esta pareja! Id preparando los corazones."; return; }
            commentaryElement.innerText = "El comentarista est√° revisando el marcador de corazones...";
            const prompt = `Est√°s comentando el sorteo SDX CUP 2026 para un grupo de chavales solteros y fiesteros. Tienen un grupo de WhatsApp aparte donde apuntan sus ligues usando emoticonos de corazones ‚ù§Ô∏è. Acaba de salir "${person}" asignado a la "Habitaci√≥n ${room}". Genera un comentario corto (1 frase), picante, con mucha guasa y un poco "canalla" sobre esa asignaci√≥n. Haz referencia directa a los ligues, a sumar corazones en el grupo, a qui√©n va a triunfar o a si esa habitaci√≥n va a ser un nido de salseo. Responde solo el comentario.`;
            const systemInstruction = "Eres un comentarista de la Champions League pero con un toque 'canallita' y vacil√≥n. Hablas espa√±ol de Espa√±a con jerga actual.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "¬°Prep√°rate para actualizar el grupo de los corazones!";
                commentaryElement.innerText = `"${text.trim()}"`;
            } catch (error) { commentaryElement.innerText = "¬°Vaya peligro tiene esta pareja! Id preparando los corazones."; }
        }

        async function getAIFarewell() {
            const farewellElement = document.getElementById('ai-farewell');
            const keyToUse = customApiKey || "";
            if (!keyToUse) { farewellElement.innerText = "¬°El sorteo ha terminado! Que los dioses del baile y del ligue os acompa√±en."; return; }
            const prompt = `El sorteo oficial de habitaciones para el SDX CUP 2026 ha finalizado. Da un discurso de clausura muy corto (2-3 frases), motivador pero con tu estilo canalla y vacil√≥n. Menciona que la suerte ya est√° echada, que el marcador de corazones ‚ù§Ô∏è es lo √∫nico que importa ahora. Usa jerga actual espa√±ola.`;
            const systemInstruction = "Eres el comentarista oficial canalla de la SDX CUP. Estilo Champions, pero muy fiestero y directo.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemInstruction }] } })
                });
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "¬°Sorteo finalizado! A por todas en Madrid.";
                farewellElement.innerText = text.trim();
            } catch (error) { farewellElement.innerText = "¬°Sorteo finalizado! Que empiece el salseo en Madrid."; }
        }

        function startDraw() {
            const input = document.getElementById('participants-input').value.trim();
            const roomCount = parseInt(document.getElementById('rooms-count').value);
            const apiKeyInput = document.getElementById('api-key-input').value.trim();
            const errorElement = document.getElementById('setup-error');
            if (!input) { errorElement.innerText = "Introduce nombres."; errorElement.classList.remove('hidden'); return; }
            participants = input.split('\n').map(n => n.trim()).filter(n => n !== "");
            customApiKey = apiKeyInput;
            if (participants.length < roomCount * 2) { errorElement.innerText = `‚ö†Ô∏è ERROR: Demasiadas habitaciones. Alguien se quedar√≠a solo.`; errorElement.classList.remove('hidden'); return; }
            if (participants.length > roomCount * 3) { errorElement.innerText = `‚ö†Ô∏è ERROR: No caben todos. M√°ximo 3 por habitaci√≥n.`; errorElement.classList.remove('hidden'); return; }
            errorElement.classList.add('hidden');
            rooms = [];
            for (let i = 1; i <= roomCount; i++) { rooms.push(i); rooms.push(i); }
            let extras = participants.length - (roomCount * 2);
            for (let i = 1; i <= extras; i++) { rooms.push(i); }
            participants = shuffle(participants);
            rooms = shuffle(rooms);
            allResults = [];
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('draw-screen').classList.remove('hidden');
            renderInitialPots();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function renderInitialPots() {
            const pPot = document.getElementById('pot-participants');
            const rPot = document.getElementById('pot-rooms');
            pPot.innerHTML = ''; rPot.innerHTML = '';
            for(let i=0; i<Math.max(participants.length, 10); i++) createPotBall(pPot, 'ball-p');
            for(let i=0; i<Math.max(rooms.length, 10); i++) createPotBall(rPot, 'ball-r');
        }

        function createPotBall(container, className) {
            const b = document.createElement('div');
            b.className = `pot-ball ${className} shuffling`;
            b.style.left = Math.random() * 70 + 15 + '%';
            b.style.top = Math.random() * 70 + 15 + '%';
            b.style.animationDelay = Math.random() * 2 + 's';
            container.appendChild(b);
        }

        async function performDraw() {
            if (isDrawing || participants.length === 0) return;
            isDrawing = true;
            document.getElementById('draw-button').disabled = true;
            document.getElementById('draw-focus-area').scrollIntoView({ behavior: 'smooth', block: 'start' });

            const pPot = document.getElementById('pot-participants');
            const rPot = document.getElementById('pot-rooms');
            const curP = document.getElementById('current-participant');
            const curR = document.getElementById('current-room');
            
            curP.innerHTML = '<div class="ball-3d shuffling"></div>';
            await sleep(1500);
            const part = participants.pop();
            const photoPath = participantPhotos[part] || "https://via.placeholder.com/150?text=" + part;
            
            curP.innerHTML = `
                <div class="reveal-3d flex flex-col items-center">
                    <div class="participant-photo-frame">
                        <img src="${photoPath}" alt="${part}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150?text=üë§'">
                    </div>
                    <div class="px-3 md:px-6 py-1 md:py-2 bg-white text-blue-950 font-bold rounded-lg shadow-2xl text-sm md:text-xl border-b-4 border-gray-300">${part}</div>
                </div>
            `;
            if (pPot.lastChild) pPot.removeChild(pPot.lastChild);
            
            await sleep(800);
            
            curR.innerHTML = '<div class="ball-3d shuffling" style="background: radial-gradient(circle at 30% 30%, var(--ucl-gold-light), var(--ucl-gold), #8a641b)"></div>';
            await sleep(1500);
            const rIdx = Math.floor(Math.random() * rooms.length);
            const rNum = rooms.splice(rIdx, 1)[0];
            curR.innerHTML = `<div class="reveal-3d px-4 md:px-6 py-2 md:py-2 result-badge-gold rounded-lg shadow-2xl text-lg md:text-2xl uppercase border-b-4 border-[#8a641b]">HAB ${rNum}</div>`;
            if (rPot.lastChild) rPot.removeChild(rPot.lastChild);
            
            getAICommentary(part, rNum);
            await sleep(1000);
            allResults.push({ name: part, room: rNum });
            const c = document.getElementById('results-container');
            const r = document.createElement('div');
            r.className = "result-row bg-white/10 p-3 md:p-4 rounded flex justify-between items-center mb-2";
            r.innerHTML = `<span class="font-bold text-base md:text-lg">${part}</span><span class="text-ucl-gold font-bold uppercase text-xs md:text-sm">Habitaci√≥n ${rNum}</span>`;
            c.prepend(r);
            
            if (participants.length === 0) {
                document.getElementById('draw-button').innerText = "Ver Resumen Final";
                document.getElementById('draw-button').onclick = showSummary;
                document.getElementById('draw-button').disabled = false;
            } else { document.getElementById('draw-button').disabled = false; }
            isDrawing = false;
        }

        function showSummary() {
            document.getElementById('draw-screen').classList.add('hidden');
            document.getElementById('summary-screen').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const grid = document.getElementById('summary-grid');
            grid.innerHTML = '';
            const map = {};
            allResults.forEach(r => { if(!map[r.room]) map[r.room] = []; map[r.room].push(r.name); });
            Object.keys(map).sort((a,b)=>a-b).forEach(room => {
                const card = document.createElement('div');
                card.className = "summary-card p-4 md:p-6 rounded-xl text-center shadow-xl";
                let type = map[room].length === 3 ? "TRIPLE" : "DOBLE";
                let membersHtml = map[room].map(m => {
                    const photoPath = participantPhotos[m] || "assets/img/participants/default.jpg";
                    return `
                        <div class="flex flex-col items-center group">
                            <div class="summary-photo-frame border-2 border-ucl-gold/30 group-hover:border-ucl-gold transition-colors">
                                <img src="${photoPath}" alt="${m}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150?text=üë§'">
                            </div>
                            <div class="text-[10px] md:text-sm font-bold text-white group-hover:text-ucl-gold transition-colors">${m}</div>
                        </div>
                    `;
                }).join('');
                card.innerHTML = `
                    <div class="text-ucl-gold text-[9px] md:text-[10px] font-bold mb-3 uppercase tracking-widest border-b border-ucl-gold/20 pb-2">HAB ${room} (${type})</div>
                    <div class="flex justify-center items-start gap-2 md:gap-4 flex-wrap">${membersHtml}</div>
                `;
                grid.appendChild(card);
            });
            getAIFarewell();
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</body>
</html>
